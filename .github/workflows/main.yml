name: Backup Docker Image with Auto Version

on:
  workflow_dispatch:
    inputs:
      source_image:
        description: 'æºé•œåƒåœ°å€'
        required: true
        default: 'ghcr.io/szemeng76/lunatv:latest'
      keep_versions:
        description: 'ä¿ç•™æœ€è¿‘å‡ ä¸ªç‰ˆæœ¬'
        required: false
        default: '3'
  schedule:
    - cron: '0 0 * * *'

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥é•œåƒæ›´æ–°
        id: check
        run: |
          # è®¾ç½®æºé•œåƒ
          SOURCE_IMAGE="${{ github.event.inputs.source_image }}"
          if [ -z "$SOURCE_IMAGE" ]; then
            SOURCE_IMAGE="ghcr.io/szemeng76/lunatv:latest"
          fi
          
          # æå–é•œåƒåç§°
          IMAGE_NAME=$(echo "$SOURCE_IMAGE" | sed 's|.*/||' | cut -d: -f1)
          TARGET_BASE="ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}"
          
          echo "SOURCE_IMAGE=$SOURCE_IMAGE" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "TARGET_BASE=$TARGET_BASE" >> $GITHUB_OUTPUT
          
          # æ‹‰å–æºé•œåƒ
          echo "ğŸ“¥ æ­£åœ¨æ‹‰å–æºé•œåƒ..."
          docker pull $SOURCE_IMAGE
          
          # è·å–æºé•œåƒçš„ digest
          SOURCE_DIGEST=$(docker inspect --format='{{.Id}}' $SOURCE_IMAGE)
          echo "SOURCE_DIGEST=$SOURCE_DIGEST" >> $GITHUB_OUTPUT
          echo "æºé•œåƒ ID: $SOURCE_DIGEST"
          
          # åˆ›å»ºè®°å½•ç›®å½•
          mkdir -p .backup-data
          DIGEST_FILE=".backup-data/${IMAGE_NAME}.digest"
          VERSION_FILE=".backup-data/${IMAGE_NAME}.version"
          
          echo "DIGEST_FILE=$DIGEST_FILE" >> $GITHUB_OUTPUT
          echo "VERSION_FILE=$VERSION_FILE" >> $GITHUB_OUTPUT
          
          # è¯»å–ä¸Šæ¬¡çš„ digest
          if [ -f "$DIGEST_FILE" ]; then
            LAST_DIGEST=$(cat "$DIGEST_FILE")
            echo "ä¸Šæ¬¡é•œåƒ ID: $LAST_DIGEST"
          else
            LAST_DIGEST=""
            echo "ğŸ“ é¦–æ¬¡å¤‡ä»½æ­¤é•œåƒ"
          fi
          
          # æ¯”è¾ƒåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
          if [ "$SOURCE_DIGEST" = "$LAST_DIGEST" ]; then
            echo "NEED_UPDATE=false" >> $GITHUB_OUTPUT
            echo "âœ… é•œåƒå†…å®¹æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
          else
            echo "NEED_UPDATE=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ æ£€æµ‹åˆ°é•œåƒæœ‰æ›´æ–°ï¼"
          fi

      - name: è®¡ç®—æ–°ç‰ˆæœ¬å·
        id: version
        if: steps.check.outputs.NEED_UPDATE == 'true'
        run: |
          VERSION_FILE="${{ steps.check.outputs.VERSION_FILE }}"
          
          if [ -f "$VERSION_FILE" ]; then
            CURRENT_VERSION=$(cat "$VERSION_FILE")
            MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
            MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
            NEW_MINOR=$((MINOR + 1))
            NEW_VERSION="${MAJOR}.${NEW_MINOR}"
          else
            NEW_VERSION="1.0"
          fi
          
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ æ–°ç‰ˆæœ¬å·: $NEW_VERSION"

      - name: æ‰“æ ‡ç­¾å¹¶æ¨é€é•œåƒ
        if: steps.check.outputs.NEED_UPDATE == 'true'
        run: |
          SOURCE="${{ steps.check.outputs.SOURCE_IMAGE }}"
          TARGET="${{ steps.check.outputs.TARGET_BASE }}"
          VERSION="${{ steps.version.outputs.NEW_VERSION }}"
          
          docker tag $SOURCE ${TARGET}:${VERSION}
          docker tag $SOURCE ${TARGET}:latest
          
          echo "ğŸ“¤ æ­£åœ¨æ¨é€é•œåƒ..."
          docker push ${TARGET}:${VERSION}
          docker push ${TARGET}:latest
          
          echo "âœ… å·²æ¨é€: ${TARGET}:${VERSION}"
          echo "âœ… å·²æ¨é€: ${TARGET}:latest"

      - name: æ¸…ç†æ—§ç‰ˆæœ¬é•œåƒ
        if: steps.check.outputs.NEED_UPDATE == 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IMAGE_NAME="${{ steps.check.outputs.IMAGE_NAME }}"
          OWNER="${{ github.repository_owner }}"
          
          # è·å–ä¿ç•™ç‰ˆæœ¬æ•°
          KEEP_VERSIONS="${{ github.event.inputs.keep_versions }}"
          if [ -z "$KEEP_VERSIONS" ]; then
            KEEP_VERSIONS=3
          fi
          
          echo "ğŸ“‹ è·å–æ‰€æœ‰é•œåƒç‰ˆæœ¬..."
          echo "ğŸ”’ ä¿ç•™æœ€è¿‘ $KEEP_VERSIONS ä¸ªç‰ˆæœ¬"
          
          # è·å–ç‰ˆæœ¬åˆ—è¡¨ï¼ˆå°è¯•ç”¨æˆ·ç«¯ç‚¹ï¼Œå¤±è´¥åˆ™å°è¯•ç»„ç»‡ç«¯ç‚¹ï¼‰
          VERSIONS_JSON=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/${OWNER}/packages/container/${IMAGE_NAME}/versions" \
            --paginate 2>/dev/null) || \
          VERSIONS_JSON=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/${OWNER}/packages/container/${IMAGE_NAME}/versions" \
            --paginate 2>/dev/null) || \
          { echo "âš ï¸ æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼Œè·³è¿‡æ¸…ç†"; exit 0; }
          
          # ç»Ÿè®¡ç‰ˆæœ¬æ•°
          TOTAL=$(echo "$VERSIONS_JSON" | jq 'length')
          echo "ğŸ“¦ å½“å‰å…±æœ‰ $TOTAL ä¸ªç‰ˆæœ¬"
          
          if [ "$TOTAL" -le "$KEEP_VERSIONS" ]; then
            echo "âœ… ç‰ˆæœ¬æ•°é‡æœªè¶…è¿‡ä¿ç•™æ•°é‡ï¼Œæ— éœ€æ¸…ç†"
            exit 0
          fi
          
          # è®¡ç®—éœ€è¦åˆ é™¤çš„æ•°é‡
          DELETE_COUNT=$((TOTAL - KEEP_VERSIONS))
          echo "ğŸ—‘ï¸ å°†åˆ é™¤ $DELETE_COUNT ä¸ªæ—§ç‰ˆæœ¬"
          
          # è·å–éœ€è¦åˆ é™¤çš„ç‰ˆæœ¬IDï¼ˆAPIè¿”å›æŒ‰æ—¶é—´é™åºï¼Œè·³è¿‡æœ€æ–°çš„å‡ ä¸ªï¼‰
          DELETE_IDS=$(echo "$VERSIONS_JSON" | jq -r ".[$KEEP_VERSIONS:][].id")
          
          # åˆ é™¤æ—§ç‰ˆæœ¬
          DELETED=0
          for VERSION_ID in $DELETE_IDS; do
            # è·å–è¯¥ç‰ˆæœ¬çš„æ ‡ç­¾
            TAGS=$(echo "$VERSIONS_JSON" | jq -r ".[] | select(.id==$VERSION_ID) | .metadata.container.tags | join(\", \")")
            
            if [ -z "$TAGS" ]; then
              TAGS="(æ— æ ‡ç­¾)"
            fi
            
            echo "  ğŸ—‘ï¸ åˆ é™¤ç‰ˆæœ¬ ID: $VERSION_ID (tags: $TAGS)"
            
            # å°è¯•ç”¨æˆ·ç«¯ç‚¹åˆ é™¤
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/users/${OWNER}/packages/container/${IMAGE_NAME}/versions/${VERSION_ID}" 2>/dev/null || \
            # å°è¯•ç»„ç»‡ç«¯ç‚¹åˆ é™¤
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/orgs/${OWNER}/packages/container/${IMAGE_NAME}/versions/${VERSION_ID}" 2>/dev/null || \
            echo "    âš ï¸ åˆ é™¤å¤±è´¥ï¼Œå¯èƒ½æƒé™ä¸è¶³"
            
            DELETED=$((DELETED + 1))
          done
          
          echo ""
          echo "âœ… æ¸…ç†å®Œæˆï¼å·²åˆ é™¤ $DELETED ä¸ªæ—§ç‰ˆæœ¬"
          echo "ğŸ“¦ å½“å‰ä¿ç•™ $KEEP_VERSIONS ä¸ªæœ€æ–°ç‰ˆæœ¬"

      - name: ä¿å­˜ç‰ˆæœ¬è®°å½•
        if: steps.check.outputs.NEED_UPDATE == 'true'
        run: |
          echo "${{ steps.check.outputs.SOURCE_DIGEST }}" > "${{ steps.check.outputs.DIGEST_FILE }}"
          echo "${{ steps.version.outputs.NEW_VERSION }}" > "${{ steps.check.outputs.VERSION_FILE }}"
          
          # æ›´æ–°å†å²è®°å½•ï¼ˆåªä¿ç•™æœ€è¿‘10æ¡ï¼‰
          HISTORY_FILE=".backup-data/${{ steps.check.outputs.IMAGE_NAME }}.history"
          echo "$(date '+%Y-%m-%d %H:%M:%S') - v${{ steps.version.outputs.NEW_VERSION }}" >> "$HISTORY_FILE"
          tail -10 "$HISTORY_FILE" > "$HISTORY_FILE.tmp" && mv "$HISTORY_FILE.tmp" "$HISTORY_FILE"

      - name: æäº¤è®°å½•åˆ°ä»“åº“
        if: steps.check.outputs.NEED_UPDATE == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .backup-data/
          git commit -m "ğŸ”– Update ${{ steps.check.outputs.IMAGE_NAME }} to v${{ steps.version.outputs.NEW_VERSION }}"
          git push

      - name: è¾“å‡ºç»“æœæ‘˜è¦
        run: |
          echo ""
          echo "==========================================" 
          if [ "${{ steps.check.outputs.NEED_UPDATE }}" = "true" ]; then
            echo "ğŸ‰ å¤‡ä»½å®Œæˆï¼"
            echo ""
            echo "ğŸ“¦ é•œåƒåç§°: ${{ steps.check.outputs.IMAGE_NAME }}"
            echo "ğŸ·ï¸  æ–°ç‰ˆæœ¬å·: v${{ steps.version.outputs.NEW_VERSION }}"
            echo "ğŸ”’ ä¿ç•™ç‰ˆæœ¬: æœ€è¿‘ ${{ github.event.inputs.keep_versions || '3' }} ä¸ª"
            echo ""
            echo "ğŸ“¥ ä½¿ç”¨æ–¹æ³•:"
            echo "   docker pull ${{ steps.check.outputs.TARGET_BASE }}:${{ steps.version.outputs.NEW_VERSION }}"
            echo "   docker pull ${{ steps.check.outputs.TARGET_BASE }}:latest"
          else
            echo "â„¹ï¸  é•œåƒæ— å˜åŒ–ï¼Œæœ¬æ¬¡è·³è¿‡æ›´æ–°"
            echo ""
            echo "ğŸ“¦ å½“å‰é•œåƒ: ${{ steps.check.outputs.TARGET_BASE }}:latest"
          fi
          echo "==========================================" 

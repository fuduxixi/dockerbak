name: Backup Docker Image

on:
  workflow_dispatch:    # 允许手动触发
    inputs:
      source_image:
        description: '源镜像地址'
        required: true
        default: 'ghcr.io/szemeng76/lunatv:latest'

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: 登录 GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 拉取源镜像
        run: docker pull ${{ github.event.inputs.source_image }}

      - name: 重新标记镜像
        run: |
          # 提取镜像名称（去掉前面的registry路径）
          IMAGE_NAME=$(echo "${{ github.event.inputs.source_image }}" | sed 's|.*/||')
          echo "TARGET_IMAGE=ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}" >> $GITHUB_ENV
          docker tag ${{ github.event.inputs.source_image }} ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}

      - name: 推送到自己的仓库
        run: docker push ${{ env.TARGET_IMAGE }}

      - name: 完成提示
        run: |
          echo "✅ 镜像已备份到: ${{ env.TARGET_IMAGE }}"
